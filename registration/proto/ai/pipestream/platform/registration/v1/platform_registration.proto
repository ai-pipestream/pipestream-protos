syntax = "proto3";

package ai.pipestream.platform.registration.v1;

import "google/protobuf/timestamp.proto";

option java_multiple_files = true;
option java_outer_classname = "PlatformRegistrationProto";
option java_package = "ai.pipestream.platform.registration.v1";

// Unified registration service for all platform services and modules.
//
// Provides centralized service discovery via Consul with health monitoring,
// module schema management via Apicurio Registry, and real-time event streaming
// for registration lifecycle tracking.
service PlatformRegistrationService {
  // Register a service or module with streaming status updates.
  //
  // Returns a stream of RegistrationEvent messages tracking progress through
  // validation, Consul registration, health check configuration, and completion.
  // For modules, also includes schema validation and Apicurio registration.
  rpc Register(RegisterRequest) returns (stream RegisterResponse);

  // Unregister a service or module from Consul and the platform registry.
  rpc Unregister(UnregisterRequest) returns (UnregisterResponse);

  // List all registered services with health status and metadata.
  rpc ListServices(ListServicesRequest) returns (ListServicesResponse);

  // List all registered modules with schema and capability information.
  rpc ListPlatformModules(ListPlatformModulesRequest) returns (ListPlatformModulesResponse);

  // Get specific service details by name or Consul service ID.
  rpc GetService(GetServiceRequest) returns (GetServiceResponse);

  // Get specific module details by name or Consul service ID.
  rpc GetModule(GetModuleRequest) returns (GetModuleResponse);

  // Resolve service endpoint for dynamic routing.
  //
  // Returns the best available instance of a service based on health and load.
  // Supports preference criteria like local instances or required capabilities.
  rpc ResolveService(ResolveServiceRequest) returns (ResolveServiceResponse);

  // Watch for real-time updates to the list of all healthy services.
  //
  // The server will send an initial list, and then send a new full
  // list whenever any service is registered, unregistered, or changes
  // its health status.
  rpc WatchServices(WatchServicesRequest) returns (stream WatchServicesResponse);

  // Watch for real-time updates to the list of all registered modules.
  //
  // The server will send an initial list, and then send a new full
  // list whenever any module is registered, unregistered, or changes
  // its health status.
  rpc WatchModules(WatchModulesRequest) returns (stream WatchModulesResponse);

  // Get module schema from Apicurio Registry.
  //
  // Retrieves either a specific version or the latest schema for a module.
  // Returns JSON Schema used for validating module configuration.
  rpc GetModuleSchema(GetModuleSchemaRequest) returns (GetModuleSchemaResponse);

  // List all available schema versions for a module.
  //
  // Provides detailed version metadata from Apicurio Registry including
  // creation timestamps and version-specific descriptions.
  rpc GetModuleSchemaVersions(GetModuleSchemaVersionsRequest) returns (GetModuleSchemaVersionsResponse);

  // Get connector schema from Apicurio Registry.
  //
  // Retrieves either a specific version or the latest schema for a connector.
  // Returns JSON Schema used for validating connector configuration.
  rpc GetConnectorSchema(GetConnectorSchemaRequest) returns (GetConnectorSchemaResponse);
}

// Type of service being registered.
enum ServiceType {
  // Unspecified service type.
  SERVICE_TYPE_UNSPECIFIED = 0;
  // Regular platform service (e.g., mapping-service, account-service).
  SERVICE_TYPE_SERVICE = 1;
  // Document processing module (implements PipeStepProcessorService).
  SERVICE_TYPE_MODULE = 2;
  // Intake Connector (implements ConnectorControlService).
  SERVICE_TYPE_CONNECTOR = 3;
}

// Connection information for reaching a service.
message Connectivity {
  // Host that clients should use to connect (advertised address).
  string advertised_host = 1;
  // Port that clients should use to connect (advertised port).
  int32 advertised_port = 2;
  // Internal host where service actually binds (for health checks from same network).
  optional string internal_host = 3;
  // Internal port where service actually binds.
  optional int32 internal_port = 4;
  // Whether TLS/SSL is enabled for connections.
  bool tls_enabled = 5;
}

// Request to register a service or module with the platform.
//
// Provides the minimal information needed for registration. For modules,
// the platform-registration-service will callback to GetServiceRegistration
// to fetch module metadata (schema, capabilities, etc.).
message RegisterRequest {
  // Service or module name (e.g., "mapping-service", "tika-parser").
  string name = 1;
  // Type of service being registered.
  ServiceType type = 2;
  // Connection information for reaching this service.
  Connectivity connectivity = 3;
  // Service version (e.g., "1.2.3").
  string version = 4;
  // Customer-defined metadata tags for custom use.
  map<string, string> metadata = 5;
  // Tags for discovery and filtering (e.g., "production", "us-east-1").
  repeated string tags = 6;
  // Service capabilities (e.g., "document-storage", "search").
  repeated string capabilities = 7;
}

// Response for Register RPC (streaming).
//
// Tracks registration progress through lifecycle stages including validation,
// Consul registration, health check configuration, and completion.
message RegisterResponse {
  // Registration event data.
  RegistrationEvent event = 1;
}

// Request to unregister a service or module.
//
// Uses natural key (name + host + port) to identify the specific
// instance to unregister from Consul and the platform registry.
message UnregisterRequest {
  // Service or module name.
  string name = 1;
  // Host where instance is running.
  string host = 2;
  // Port where instance accepts connections.
  int32 port = 3;
}

// Response from unregistration operation.
message UnregisterResponse {
  // Whether unregistration succeeded.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // Timestamp when unregistration completed.
  google.protobuf.Timestamp timestamp = 3;
}

// Streaming registration event tracking registration progress.
//
// Sent during Register RPC to provide real-time updates on registration
// lifecycle stages including validation, Consul registration, health check
// configuration, schema registration (modules), and completion.
message RegistrationEvent {
  // Type of event indicating the registration stage.
  PlatformEventType event_type = 1;
  // Timestamp when this event occurred.
  google.protobuf.Timestamp timestamp = 2;
  // Human-readable message describing the event.
  string message = 3;
  // Event-specific data providing additional context.
  oneof event_data {
    // Consul service ID when successfully registered.
    string service_id = 4;
    // Error details if registration failed.
    string error_detail = 5;
    // Additional event metadata as key-value pairs.
    EventMetadata metadata = 6;
  }
}

// Event metadata wrapper for key-value pairs.
//
// Required because maps cannot be used directly in oneofs.
message EventMetadata {
  // Metadata values as key-value pairs.
  map<string, string> values = 1;
}

// Registration event types tracking lifecycle stages.
//
// Represents the progression of service or module registration from initial
// validation through Consul registration, health checks, schema validation,
// and final completion or failure.
enum PlatformEventType {
  // Unspecified event type.
  PLATFORM_EVENT_TYPE_UNSPECIFIED = 0;
  // Registration process started.
  PLATFORM_EVENT_TYPE_STARTED = 1;
  // Input validated successfully.
  PLATFORM_EVENT_TYPE_VALIDATED = 2;
  // Successfully registered with Consul.
  PLATFORM_EVENT_TYPE_CONSUL_REGISTERED = 3;
  // Health check configured in Consul.
  PLATFORM_EVENT_TYPE_HEALTH_CHECK_CONFIGURED = 4;
  // Service reported healthy to Consul.
  PLATFORM_EVENT_TYPE_CONSUL_HEALTHY = 5;
  // Registration completed successfully.
  PLATFORM_EVENT_TYPE_COMPLETED = 6;
  // Registration failed at any stage.
  PLATFORM_EVENT_TYPE_FAILED = 7;
  // Module metadata fetched from module callback (modules only).
  PLATFORM_EVENT_TYPE_METADATA_RETRIEVED = 8;
  // Schema validated or synthesized (modules only).
  PLATFORM_EVENT_TYPE_SCHEMA_VALIDATED = 9;
  // Registration persisted to database.
  PLATFORM_EVENT_TYPE_DATABASE_SAVED = 10;
  // Schema registered in Apicurio Registry (modules only).
  PLATFORM_EVENT_TYPE_APICURIO_REGISTERED = 11;
}

// Request to look up service details.
//
// Supports lookup by logical name (returns all instances) or by specific
// Consul service ID (returns single instance).
message GetServiceRequest {
  // Lookup key for finding the service.
  oneof lookup_key {
    // Look up by logical name (returns all instances).
    string service_name = 1;
    // Look up by specific Consul service ID (returns single instance).
    string service_id = 2;
  }
}

// Request to look up module details.
//
// Supports lookup by logical name (returns all instances) or by specific
// Consul service ID (returns single instance).
message GetModuleRequest {
  // Lookup key for finding the module.
  oneof lookup_key {
    // Look up by logical name (returns all instances).
    string module_name = 1;
    // Look up by specific Consul service ID (returns single instance).
    string service_id = 2;
  }
}

// Request to resolve service endpoint for dynamic routing.
//
// Finds the best available service instance based on health status, load,
// and optional preference criteria like locality or required capabilities.
message ResolveServiceRequest {
  // Service name to resolve (e.g., "mapping-service").
  string service_name = 1;
  // Prefer instance on same host as caller.
  bool prefer_local = 2;
  // Only return instances with all of these tags.
  repeated string required_tags = 3;
  // Only return instances with all of these capabilities.
  repeated string required_capabilities = 4;
}

// Response from service resolution containing the best available instance.
//
// Provides complete connection details for the selected instance along with
// metadata explaining the selection decision.
message ResolveServiceResponse {
  // Whether a healthy instance was found.
  bool found = 1;
  // Service name that was resolved.
  string service_name = 2;
  // Host of the selected instance.
  string host = 3;
  // Port of the selected instance.
  int32 port = 4;
  // Consul service ID of the selected instance.
  string service_id = 5;
  // Additional metadata from the selected instance.
  map<string, string> metadata = 6;
  // Tags associated with the selected instance.
  repeated string tags = 7;
  // Capabilities of the selected instance.
  repeated string capabilities = 8;
  // Version of the selected instance.
  string version = 9;
  // Total number of instances found (including unhealthy).
  int32 total_instances = 10;
  // Number of healthy instances considered.
  int32 healthy_instances = 11;
  // Explanation of why this instance was selected.
  string selection_reason = 12;
  // Timestamp when resolution occurred.
  google.protobuf.Timestamp resolved_at = 13;
}

// Complete details for a registered service instance.
//
// Includes connection information, metadata, health status, and registration timestamps.
message GetServiceResponse {
  // Logical service name.
  string service_name = 1;
  // Consul service ID for this specific instance.
  string service_id = 2;
  // Host where service is running.
  string host = 3;
  // Port where service accepts connections.
  int32 port = 4;
  // Service version.
  string version = 5;
  // Service metadata.
  map<string, string> metadata = 6;
  // Service tags for discovery.
  repeated string tags = 7;
  // Service capabilities.
  repeated string capabilities = 8;
  // Whether this instance is currently healthy.
  bool is_healthy = 9;
  // Timestamp when service was registered.
  google.protobuf.Timestamp registered_at = 10;
  // Timestamp of last health check.
  google.protobuf.Timestamp last_health_check = 11;
}

// Complete details for a registered module instance.
//
// Extends service details with module-specific information including
// input/output formats and document type support.
message GetModuleResponse {
  // Module name.
  string module_name = 1;
  // Consul service ID for this specific instance.
  string service_id = 2;
  // Host where module is running.
  string host = 3;
  // Port where module accepts connections.
  int32 port = 4;
  // Module version.
  string version = 5;
  // Module metadata.
  map<string, string> metadata = 6;
  // Input format expected by module (e.g., "PipeDoc", "text/plain").
  string input_format = 7;
  // Output format produced by module (e.g., "PipeDoc", "application/json").
  string output_format = 8;
  // Document types this module can process (e.g., "pdf", "docx", "image").
  repeated string document_types = 9;
  // Whether this instance is currently healthy.
  bool is_healthy = 10;
  // Timestamp when module was registered.
  google.protobuf.Timestamp registered_at = 11;
  // Timestamp of last health check.
  google.protobuf.Timestamp last_health_check = 12;
}

// Request to list all registered services.
message ListServicesRequest {}

// Request to list all registered modules.
message ListPlatformModulesRequest {}

// Request to watch for service registration changes.
message WatchServicesRequest {}

// Request to watch for module registration changes.
message WatchModulesRequest {}

// Response containing list of all registered services.
message ListServicesResponse {
  // List of all registered service instances with their details.
  repeated GetServiceResponse services = 1;
  // Timestamp when this snapshot was captured.
  google.protobuf.Timestamp as_of = 2;
  // Total count of service instances.
  int32 total_count = 3;
}

// Response for WatchServices RPC (streaming).
message WatchServicesResponse {
  // List of all registered service instances with their details.
  repeated GetServiceResponse services = 1;
  // Timestamp when this snapshot was captured.
  google.protobuf.Timestamp as_of = 2;
  // Total count of service instances.
  int32 total_count = 3;
}

// Response containing list of all registered modules.
message ListPlatformModulesResponse {
  // List of all registered module instances with their details.
  repeated GetModuleResponse modules = 1;
  // Timestamp when this snapshot was captured.
  google.protobuf.Timestamp as_of = 2;
  // Total count of module instances.
  int32 total_count = 3;
}

// Response for WatchModules RPC (streaming).
message WatchModulesResponse {
  // List of all registered module instances with their details.
  repeated GetModuleResponse modules = 1;
  // Timestamp when this snapshot was captured.
  google.protobuf.Timestamp as_of = 2;
  // Total count of module instances.
  int32 total_count = 3;
}

// Event published to Kafka when a service is registered.
//
// Used for OpenSearch indexing and event tracking. Published after
// successful Consul registration and health check configuration.
message ServiceRegistered {
  // Consul service ID.
  string service_id = 1;
  // Logical service name.
  string service_name = 2;
  // Host where service is running.
  string host = 3;
  // Port where service accepts connections.
  int32 port = 4;
  // Service version.
  string version = 5;
  // Timestamp when service was registered.
  google.protobuf.Timestamp timestamp = 6;
}

// Event published to Kafka when a service is unregistered.
//
// Used for OpenSearch indexing and event tracking. Published after
// successful removal from Consul.
message ServiceUnregistered {
  // Consul service ID that was unregistered.
  string service_id = 1;
  // Logical service name.
  string service_name = 2;
  // Timestamp when service was unregistered.
  google.protobuf.Timestamp timestamp = 3;
}

// Event published to Kafka when a module is registered.
//
// Used for OpenSearch indexing and event tracking. Published after
// successful Consul registration, schema validation, and Apicurio registration.
message ModuleRegistered {
  // Consul service ID.
  string service_id = 1;
  // Module name.
  string module_name = 2;
  // Host where module is running.
  string host = 3;
  // Port where module accepts connections.
  int32 port = 4;
  // Module version.
  string version = 5;
  // Internal schema identifier.
  string schema_id = 6;
  // Apicurio Registry artifact ID for module schema.
  string apicurio_artifact_id = 7;
  // Timestamp when module was registered.
  google.protobuf.Timestamp timestamp = 8;
}

// Event published to Kafka when a module is unregistered.
//
// Used for OpenSearch indexing and event tracking. Published after
// successful removal from Consul.
message ModuleUnregistered {
  // Consul service ID that was unregistered.
  string service_id = 1;
  // Module name.
  string module_name = 2;
  // Timestamp when module was unregistered.
  google.protobuf.Timestamp timestamp = 3;
}

// Request to retrieve module configuration schema from Apicurio Registry.
message GetModuleSchemaRequest {
  // Module name (e.g., "chunker", "parser").
  string module_name = 1;
  // Specific version to retrieve. If omitted, returns latest from Apicurio.
  optional string version = 2;
}

// Response containing module configuration schema.
//
// Provides JSON Schema definition used to validate module configuration
// along with version information and available versions.
message GetModuleSchemaResponse {
  // Module name.
  string module_name = 1;
  // JSON Schema definition as string.
  string schema_json = 2;
  // Current schema version (e.g., "1.2.3").
  string schema_version = 3;
  // Apicurio Registry artifact ID.
  string artifact_id = 4;
  // Additional metadata (author, description, etc.).
  map<string, string> metadata = 5;
  // Timestamp when schema was last updated in Apicurio Registry.
  google.protobuf.Timestamp updated_at = 6;
  // All versions available in Apicurio Registry.
  repeated string available_versions = 7;
}

// Request to list all schema versions for a module.
message GetModuleSchemaVersionsRequest {
  // Module name to get versions for.
  string module_name = 1;
}

// Response containing all schema versions for a module.
//
// Provides detailed version history from Apicurio Registry including
// creation timestamps and version-specific metadata.
message GetModuleSchemaVersionsResponse {
  // Module name.
  string module_name = 1;
  // Apicurio Registry artifact ID.
  string artifact_id = 2;
  // Detailed information for each version.
  repeated ModuleSchemaVersion versions = 3;
  // Latest version string for convenience.
  string latest_version = 4;
}

// Request to retrieve connector configuration schema from Apicurio Registry.
message GetConnectorSchemaRequest {
  // Connector type (e.g., "s3", "file-crawler").
  string connector_type = 1;
  // Specific version to retrieve. If omitted, returns latest from Apicurio.
  optional string version = 2;
}

// Response containing connector configuration schema.
//
// Provides JSON Schema definition used to validate connector configuration
// along with version information and available versions.
message GetConnectorSchemaResponse {
  // Connector type.
  string connector_type = 1;
  // JSON Schema definition as string.
  string schema_json = 2;
  // Current schema version (e.g., "1.2.3").
  string schema_version = 3;
  // Apicurio Registry artifact ID.
  string artifact_id = 4;
  // Additional metadata (author, description, etc.).
  map<string, string> metadata = 5;
  // Timestamp when schema was last updated in Apicurio Registry.
  google.protobuf.Timestamp updated_at = 6;
  // All versions available in Apicurio Registry.
  repeated string available_versions = 7;
}

// Metadata for a single schema version.
message ModuleSchemaVersion {
  // Version string (e.g., "1.2.3").
  string version = 1;
  // Timestamp when this version was created.
  google.protobuf.Timestamp created_at = 2;
  // Version-specific metadata.
  map<string, string> metadata = 3;
  // Optional version description or changelog.
  optional string description = 4;
}
