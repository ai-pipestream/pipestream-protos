syntax = "proto3";

package ai.pipestream.connector.intake.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

option java_multiple_files = true;
option java_package = "ai.pipestream.connector.intake.v1";

// ============================================
// CONNECTOR REGISTRATION SERVICE (connector-admin)
// Manages connector type defaults + JSON Schema registration for custom config
// ============================================

// Administrative APIs for managing connector registration metadata and custom config JSON Schemas.
//
// Note: Strongly-typed Tier 1 config (persistence/retention/encryption/hydration) is protobuf-based and
// is not represented as JSON Schema. JSON Schema is used ONLY for connector-specific custom config.
service ConnectorRegistrationService {
  // Create a new schema version for a connector type.
  rpc CreateConnectorConfigSchema(CreateConnectorConfigSchemaRequest) returns (CreateConnectorConfigSchemaResponse);

  // Get schema details by schema_id.
  rpc GetConnectorConfigSchema(GetConnectorConfigSchemaRequest) returns (GetConnectorConfigSchemaResponse);

  // List schema versions registered for a connector type.
  rpc ListConnectorConfigSchemas(ListConnectorConfigSchemasRequest) returns (ListConnectorConfigSchemasResponse);

  // Delete a schema version (only allowed when not referenced by any Connector/DataSource).
  rpc DeleteConnectorConfigSchema(DeleteConnectorConfigSchemaRequest) returns (DeleteConnectorConfigSchemaResponse);

  // Update connector type defaults (Tier 1 defaults + UI metadata).
  rpc UpdateConnectorTypeDefaults(UpdateConnectorTypeDefaultsRequest) returns (UpdateConnectorTypeDefaultsResponse);

  // Set (or clear) the schema_id referenced by a connector type.
  rpc SetConnectorCustomConfigSchema(SetConnectorCustomConfigSchemaRequest) returns (SetConnectorCustomConfigSchemaResponse);
}

// Connector configuration schema entity (JSON Schema for custom config only).
message ConnectorConfigSchema {
  string schema_id = 1;
  string connector_id = 2;
  string schema_version = 3;

  // JSON Schema for Tier 1 custom config (datasource-level).
  google.protobuf.Struct custom_config_schema = 4;

  // JSON Schema for Tier 2 node custom config (graph/node-level).
  google.protobuf.Struct node_custom_config_schema = 5;

  google.protobuf.Timestamp created_at = 6;
  string created_by = 7;

  // Apicurio integration metadata (mirrors DB columns).
  string apicurio_artifact_id = 8;
  int64 apicurio_global_id = 9;
  string sync_status = 10; // PENDING, SYNCED, FAILED
  google.protobuf.Timestamp last_sync_attempt = 11;
  string sync_error = 12;
}

message CreateConnectorConfigSchemaRequest {
  // Optional. If omitted, server generates a UUID.
  string schema_id = 1;
  string connector_id = 2;
  string schema_version = 3;
  google.protobuf.Struct custom_config_schema = 4;
  google.protobuf.Struct node_custom_config_schema = 5;
  string created_by = 6;
}

message CreateConnectorConfigSchemaResponse {
  bool success = 1;
  string message = 2;
  ConnectorConfigSchema schema = 3;
}

message GetConnectorConfigSchemaRequest {
  string schema_id = 1;
}

message GetConnectorConfigSchemaResponse {
  ConnectorConfigSchema schema = 1;
}

message ListConnectorConfigSchemasRequest {
  string connector_id = 1;
  int32 page_size = 2;
  string page_token = 3;
}

message ListConnectorConfigSchemasResponse {
  repeated ConnectorConfigSchema schemas = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message DeleteConnectorConfigSchemaRequest {
  string schema_id = 1;
}

message DeleteConnectorConfigSchemaResponse {
  bool success = 1;
  string message = 2;
}

message UpdateConnectorTypeDefaultsRequest {
  string connector_id = 1;

  // Optional fields (only applied when set / non-empty).
  optional bool default_persist_pipedoc = 2;
  optional int32 default_max_inline_size_bytes = 3;
  google.protobuf.Struct default_custom_config = 4;

  string display_name = 5;
  string owner = 6;
  string documentation_url = 7;
  repeated string tags = 8;
}

message UpdateConnectorTypeDefaultsResponse {
  bool success = 1;
  string message = 2;
  Connector connector = 3;
}

message SetConnectorCustomConfigSchemaRequest {
  string connector_id = 1;
  // Set to empty string to clear.
  string schema_id = 2;
}

message SetConnectorCustomConfigSchemaResponse {
  bool success = 1;
  string message = 2;
  Connector connector = 3;
}


