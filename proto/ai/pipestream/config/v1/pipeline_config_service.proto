syntax = "proto3";

package ai.pipestream.config.v1;

import "ai/pipestream/config/v1/pipeline_config_models.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

option java_package = "ai.pipestream.config.v1";
option java_multiple_files = true;

// PipeStream Engine Configuration Service
// Replaces Consul-based configuration with gRPC streaming
service PipelineConfigService {
  // Cluster Management
  rpc CreateCluster(CreateClusterRequest) returns (CreateClusterResponse);
  // Retrieves a single cluster by ID.
  rpc GetCluster(GetClusterRequest) returns (GetClusterResponse);
  // Lists all clusters with optional filtering.
  rpc ListClusters(ListClustersRequest) returns (ListClustersResponse);
  // Updates an existing cluster configuration.
  rpc UpdateCluster(UpdateClusterRequest) returns (UpdateClusterResponse);
  // Deletes a cluster and all associated resources.
  rpc DeleteCluster(DeleteClusterRequest) returns (DeleteClusterResponse);

  // Pipeline Configuration Management
  rpc CreatePipelineGraph(CreatePipelineGraphRequest) returns (CreatePipelineGraphResponse);
  // Retrieves a pipeline configuration by ID.
  rpc GetPipelineConfig(GetPipelineConfigRequest) returns (GetPipelineConfigResponse);
  // Lists all pipeline graphs with optional filtering.
  rpc ListPipelineGraphs(ListPipelineGraphsRequest) returns (ListPipelineGraphsResponse);
  // Updates an existing pipeline graph.
  rpc UpdatePipelineGraph(UpdatePipelineGraphRequest) returns (UpdatePipelineGraphResponse);
  // Deletes a pipeline graph.
  rpc DeletePipelineGraph(DeletePipelineGraphRequest) returns (DeletePipelineGraphResponse);

  // Pipeline Instance Management
  rpc CreatePipelineInstance(CreatePipelineInstanceRequest) returns (CreatePipelineInstanceResponse);
  // Retrieves a pipeline instance by ID.
  rpc GetPipelineInstance(GetPipelineInstanceRequest) returns (GetPipelineInstanceResponse);
  // Lists all pipeline instances with optional filtering.
  rpc ListPipelineInstances(ListPipelineInstancesRequest) returns (ListPipelineInstancesResponse);
  // Updates an existing pipeline instance configuration.
  rpc UpdatePipelineInstance(UpdatePipelineInstanceRequest) returns (UpdatePipelineInstanceResponse);
  // Deletes a pipeline instance.
  rpc DeletePipelineInstance(DeletePipelineInstanceRequest) returns (DeletePipelineInstanceResponse);
  // Starts a stopped pipeline instance.
  rpc StartPipelineInstance(StartPipelineInstanceRequest) returns (StartPipelineInstanceResponse);
  // Stops a running pipeline instance.
  rpc StopPipelineInstance(StopPipelineInstanceRequest) returns (StopPipelineInstanceResponse);

  // Module Registration & Discovery
  rpc RegisterModule(RegisterModuleRequest) returns (RegisterModuleResponse);
  // Unregisters a module from the registry.
  rpc UnregisterModule(UnregisterModuleRequest) returns (UnregisterModuleResponse);
  // Lists all registered modules.
  rpc ListModules(ListModulesRequest) returns (ListModulesResponse);
  // Checks health status of a specific module.
  rpc GetModuleHealth(GetModuleHealthRequest) returns (GetModuleHealthResponse);

  // Real-time Configuration Streaming (replaces Consul watches)
  rpc WatchClusterConfig(WatchClusterConfigRequest) returns (stream WatchClusterConfigResponse);
  // Streams real-time pipeline graph configuration changes.
  rpc WatchPipelineGraph(WatchPipelineGraphRequest) returns (stream WatchPipelineGraphResponse);
  // Streams real-time module registry changes.
  rpc WatchModuleRegistry(WatchModuleRegistryRequest) returns (stream WatchModuleRegistryResponse);
  
  // Module Whitelisting
  rpc WhitelistModule(WhitelistModuleRequest) returns (WhitelistModuleResponse);
  // Removes a module from the whitelist.
  rpc RemoveModuleFromWhitelist(RemoveModuleFromWhitelistRequest) returns (RemoveModuleFromWhitelistResponse);
  // Lists all whitelisted modules.
  rpc ListWhitelistedModules(ListWhitelistedModulesRequest) returns (ListWhitelistedModulesResponse);
}

// Request to create a new cluster.
message CreateClusterRequest {
  // Unique cluster name.
  string cluster_name = 1;
  // Cluster metadata and configuration.
  ClusterMetadata metadata = 2;
}

// Response from cluster creation.
message CreateClusterResponse {
  // Whether creation was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // Created cluster.
  Cluster cluster = 3;
}

// Request to retrieve a cluster.
message GetClusterRequest {
  // Cluster name to retrieve.
  string cluster_name = 1;
}

// Response containing cluster details.
message GetClusterResponse {
  // The requested cluster.
  Cluster cluster = 1;
}

// Request to list clusters.
message ListClustersRequest {
  // Number of results per page.
  int32 page_size = 1;
  // Pagination token.
  string page_token = 2;
}

// Response containing cluster list.
message ListClustersResponse {
  // List of clusters.
  repeated Cluster clusters = 1;
  // Token for next page.
  string next_page_token = 2;
}

// Request to update a cluster.
message UpdateClusterRequest {
  // Cluster name to update.
  string cluster_name = 1;
  // Updated metadata.
  ClusterMetadata metadata = 2;
}

// Response from cluster update.
message UpdateClusterResponse {
  // Whether update was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // Updated cluster.
  Cluster cluster = 3;
}

// Request to delete a cluster.
message DeleteClusterRequest {
  // Cluster name to delete.
  string cluster_name = 1;
}

// Response from cluster deletion.
message DeleteClusterResponse {
  // Whether deletion was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
}

// Request to create a pipeline graph.
message CreatePipelineGraphRequest {
  // Cluster where graph will be created.
  string cluster_name = 1;
  // Pipeline graph definition.
  PipelineGraph pipeline_graph = 2;
}

// Response from pipeline graph creation.
message CreatePipelineGraphResponse {
  // Whether creation was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // Created pipeline graph.
  PipelineGraph pipeline_graph = 3;
}

// Request to retrieve a pipeline graph.
message GetPipelineGraphRequest {
  // Cluster containing the graph.
  string cluster_name = 1;
  // Graph name to retrieve.
  string graph_name = 2;
}

// Request to retrieve pipeline configuration.
message GetPipelineConfigRequest {
  // Cluster containing the configuration.
  string cluster_name = 1;
  // Configuration name to retrieve.
  string graph_name = 2;
}

// Response containing pipeline configuration.
message GetPipelineConfigResponse {
  // The requested pipeline graph.
  PipelineGraph graph = 1;
}

// Request to list pipeline graphs.
message ListPipelineGraphsRequest {
  // Cluster to list graphs from.
  string cluster_name = 1;
  // Number of results per page.
  int32 page_size = 2;
  // Pagination token.
  string page_token = 3;
}

// Response containing pipeline graph list.
message ListPipelineGraphsResponse {
  // List of pipeline graphs.
  repeated PipelineGraph pipeline_graphs = 1;
  // Token for next page.
  string next_page_token = 2;
}

// Request to update a pipeline graph.
message UpdatePipelineGraphRequest {
  // Cluster containing the graph.
  string cluster_name = 1;
  // Updated pipeline graph.
  PipelineGraph pipeline_graph = 2;
}

// Response from pipeline graph update.
message UpdatePipelineGraphResponse {
  // Whether update was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // Updated pipeline graph.
  PipelineGraph pipeline_graph = 3;
}

// Request to delete a pipeline graph.
message DeletePipelineGraphRequest {
  // Cluster containing the graph.
  string cluster_name = 1;
  // Graph name to delete.
  string graph_name = 2;
}

// Response from pipeline graph deletion.
message DeletePipelineGraphResponse {
  // Whether deletion was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
}

// Request to create a pipeline instance.
message CreatePipelineInstanceRequest {
  // Pipeline instance definition.
  PipelineInstance instance = 1;
}

// Response from pipeline instance creation.
message CreatePipelineInstanceResponse {
  // Whether creation was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // Created pipeline instance.
  PipelineInstance instance = 3;
}

// Request to retrieve a pipeline instance.
message GetPipelineInstanceRequest {
  // Cluster containing the instance.
  string cluster_name = 1;
  // Instance ID to retrieve.
  string instance_id = 2;
}

// Response containing pipeline instance details.
message GetPipelineInstanceResponse {
  // The requested pipeline instance.
  PipelineInstance instance = 1;
}

// Request to list pipeline instances.
message ListPipelineInstancesRequest {
  // Cluster to list instances from.
  string cluster_name = 1;
  // Optional filter by pipeline definition ID.
  string pipeline_definition_id = 2;
  // Optional filter by status.
  PipelineInstanceStatus status = 3;
  // Number of results per page.
  int32 page_size = 4;
  // Pagination token.
  string page_token = 5;
}

// Response containing pipeline instance list.
message ListPipelineInstancesResponse {
  // List of pipeline instances.
  repeated PipelineInstance instances = 1;
  // Token for next page.
  string next_page_token = 2;
}

// Request to update a pipeline instance.
message UpdatePipelineInstanceRequest {
  // Updated pipeline instance.
  PipelineInstance instance = 1;
}

// Response from pipeline instance update.
message UpdatePipelineInstanceResponse {
  // Whether update was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // Updated pipeline instance.
  PipelineInstance instance = 3;
}

// Request to delete a pipeline instance.
message DeletePipelineInstanceRequest {
  // Cluster containing the instance.
  string cluster_name = 1;
  // Instance ID to delete.
  string instance_id = 2;
}

// Response from pipeline instance deletion.
message DeletePipelineInstanceResponse {
  // Whether deletion was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
}

// Request to start a pipeline instance.
message StartPipelineInstanceRequest {
  // Cluster containing the instance.
  string cluster_name = 1;
  // Instance ID to start.
  string instance_id = 2;
}

// Response from starting pipeline instance.
message StartPipelineInstanceResponse {
  // Whether start was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // Started pipeline instance.
  PipelineInstance instance = 3;
}

// Request to stop a pipeline instance.
message StopPipelineInstanceRequest {
  // Cluster containing the instance.
  string cluster_name = 1;
  // Instance ID to stop.
  string instance_id = 2;
}

// Response from stopping pipeline instance.
message StopPipelineInstanceResponse {
  // Whether stop was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // Stopped pipeline instance.
  PipelineInstance instance = 3;
}

// Request to register a module.
message RegisterModuleRequest {
  // Module registration information.
  ModuleRegistration registration = 1;
}

// Response from module registration.
message RegisterModuleResponse {
  // Whether registration was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // Registered module information.
  ModuleRegistration registration = 3;
}

// Request to unregister a module.
message UnregisterModuleRequest {
  // Module ID to unregister.
  string module_id = 1;
}

// Response from module unregistration.
message UnregisterModuleResponse {
  // Whether unregistration was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
}

// Request to list registered modules.
message ListModulesRequest {
  // Cluster to list modules from.
  string cluster_name = 1;
  // Optional filter by visibility.
  ModuleVisibility visibility_filter = 2;
  // Number of results per page.
  int32 page_size = 3;
  // Pagination token.
  string page_token = 4;
}

// Response containing module list.
message ListModulesResponse {
  // List of registered modules.
  repeated ModuleRegistration modules = 1;
  // Token for next page.
  string next_page_token = 2;
}

// Request to check module health.
message GetModuleHealthRequest {
  // Module ID to check health for.
  string module_id = 1;
}

// Response containing module health status.
message GetModuleHealthResponse {
  // Module registration information.
  ModuleRegistration registration = 1;
  // Whether module is healthy.
  bool is_healthy = 2;
  // Health status message.
  string health_message = 3;
}

// Request to watch cluster configuration changes.
//
// Streams real-time updates, replacing Consul watches.
message WatchClusterConfigRequest {
  // Cluster to watch for changes.
  string cluster_name = 1;
}

// Cluster configuration change event.
message ClusterConfigEvent {
  // Type of event (created, updated, deleted).
  EventType event_type = 1;
  // Affected cluster.
  Cluster cluster = 2;
  // Timestamp when event occurred.
  google.protobuf.Timestamp timestamp = 3;
}

// Response for watch cluster config stream.
message WatchClusterConfigResponse {
  // Cluster configuration event.
  ClusterConfigEvent event = 1;
}

// Request to watch pipeline graph changes.
message WatchPipelineGraphRequest {
  // Cluster to watch.
  string cluster_name = 1;
  // Specific graph name to watch (empty for all graphs in cluster).
  string graph_name = 2;
}

// Pipeline graph change event.
message PipelineGraphEvent {
  // Type of event (created, updated, deleted).
  EventType event_type = 1;
  // Affected pipeline graph.
  PipelineGraph pipeline_graph = 2;
  // Cluster containing the graph.
  string cluster_name = 3;
  // Timestamp when event occurred.
  google.protobuf.Timestamp timestamp = 4;
}

// Response for watch pipeline graph stream.
message WatchPipelineGraphResponse {
  // Pipeline graph event.
  PipelineGraphEvent event = 1;
}

// Request to watch module registry changes.
message WatchModuleRegistryRequest {
  // Cluster to watch.
  string cluster_name = 1;
  // Optional visibility filter.
  ModuleVisibility visibility_filter = 2;
}

// Module registry change event.
message ModuleRegistryEvent {
  // Type of event (created, updated, deleted).
  EventType event_type = 1;
  // Affected module registration.
  ModuleRegistration registration = 2;
  // Timestamp when event occurred.
  google.protobuf.Timestamp timestamp = 3;
}

// Response for watch module registry stream.
message WatchModuleRegistryResponse {
  // Module registry event.
  ModuleRegistryEvent event = 1;
}

// Type of configuration event.
enum EventType {
  // Unspecified event type.
  EVENT_TYPE_UNSPECIFIED = 0;
  // Entity was created.
  EVENT_TYPE_CREATED = 1;
  // Entity was updated.
  EVENT_TYPE_UPDATED = 2;
  // Entity was deleted.
  EVENT_TYPE_DELETED = 3;
}

// Request to whitelist a module.
message WhitelistModuleRequest {
  // Cluster to whitelist module in.
  string cluster_name = 1;
  // Module implementation name.
  string implementation_name = 2;
  // Module gRPC service name.
  string grpc_service_name = 3;
  // Reference to custom configuration schema.
  SchemaReference custom_config_schema_reference = 4;
  // Custom configuration for the module.
  google.protobuf.Struct custom_config = 5;
}

// Response from module whitelisting.
message WhitelistModuleResponse {
  // Whether whitelisting was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
  // List of validation errors.
  repeated string errors = 3;
  // List of validation warnings.
  repeated string warnings = 4;
}

// Request to remove module from whitelist.
message RemoveModuleFromWhitelistRequest {
  // Cluster containing the module.
  string cluster_name = 1;
  // Module implementation ID to remove.
  string implementation_id = 2;
}

// Response from removing module from whitelist.
message RemoveModuleFromWhitelistResponse {
  // Whether removal was successful.
  bool success = 1;
  // Status or error message.
  string message = 2;
}

// Request to list whitelisted modules.
message ListWhitelistedModulesRequest {
  // Cluster to list modules from.
  string cluster_name = 1;
  // Number of results per page.
  int32 page_size = 2;
  // Pagination token.
  string page_token = 3;
}

// Response containing whitelisted modules list.
message ListWhitelistedModulesResponse {
  // List of whitelisted module definitions.
  repeated ModuleDefinition modules = 1;
  // Token for next page.
  string next_page_token = 2;
}