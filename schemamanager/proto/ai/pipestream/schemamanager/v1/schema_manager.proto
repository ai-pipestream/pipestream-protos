syntax = "proto3";

package ai.pipestream.schemamanager.v1;

import "google/protobuf/wrappers.proto";

option java_multiple_files = true;
option java_package = "ai.pipestream.schemamanager.v1";

// The SchemaManagerService is responsible for dynamically managing OpenSearch index schemas.
// It provides an idempotent API to ensure that the necessary mappings exist for the "Embedded Object" strategy.
service SchemaManagerService {
  // Ensures that the index has a 'nested' field configured for storing chunked embeddings.
  // This operation is idempotent. It checks for the existence of the nested mapping
  // and only creates or updates it if necessary, using a distributed lock to prevent race conditions.
  rpc EnsureNestedEmbeddingsFieldExists(EnsureNestedEmbeddingsFieldExistsRequest) returns (EnsureNestedEmbeddingsFieldExistsResponse);
}

message EnsureNestedEmbeddingsFieldExistsRequest {
  // The name of the OpenSearch index to check and potentially update.
  // Example: "pipeline-articles-v1"
  string index_name = 1;

  // The name of the nested field that will contain the array of embedding objects.
  // Example: "embeddings"
  string nested_field_name = 2;

  // The definition for the 'vector' field that will live inside the nested objects.
  VectorFieldDefinition vector_field_definition = 3;
}

// Defines the configuration for a knn_vector field.
message VectorFieldDefinition {
  // The number of dimensions in the vector. This is mandatory.
  int32 dimension = 1;

  // The k-NN method definition, containing the engine, space type, and tuning parameters.
  KnnMethodDefinition knn_method = 2;
}

// Defines the k-NN method and its parameters, mirroring the user-facing configuration.
message KnnMethodDefinition {
  // k-NN engine options for vector similarity search
  enum KnnEngine {
    // Unspecified engine (defaults to OpenSearch default)
    KNN_ENGINE_UNSPECIFIED = 0;
  }

  // Distance metrics for vector similarity calculation
  enum SpaceType {
    // Unspecified space type
    SPACE_TYPE_UNSPECIFIED = 0;
    // Cosine similarity: measures angle between vectors (normalized dot product)
    SPACE_TYPE_COSINESIMIL = 1;
    // Inner product: raw dot product similarity
    SPACE_TYPE_INNERPRODUCT = 2;
  }

  // k-NN engine to use for indexing and search
  KnnEngine engine = 1;
  // Distance metric to use for vector similarity
  SpaceType space_type = 2;
  // Algorithm-specific tuning parameters (HNSW)
  KnnParametersDefinition parameters = 3;
}

// Defines the tuning parameters for the HNSW (Hierarchical Navigable Small World) algorithm.
// Using google.protobuf.Int32Value allows us to distinguish between a value of 0 and an omitted field.
// These parameters control the tradeoff between search accuracy, speed, and index size.
message KnnParametersDefinition {
  // Number of bi-directional links per node (higher = more accurate but larger index)
  google.protobuf.Int32Value m = 1;
  // Size of dynamic candidate list during index construction (higher = better quality)
  google.protobuf.Int32Value ef_construction = 2;
  // Size of dynamic candidate list during search (higher = more accurate but slower)
  google.protobuf.Int32Value ef_search = 3;
}

message EnsureNestedEmbeddingsFieldExistsResponse {
  // True if the nested embeddings field already existed and was correctly configured.
  bool schema_existed = 1;
}
