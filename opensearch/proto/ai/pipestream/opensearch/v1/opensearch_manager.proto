syntax = "proto3";

package ai.pipestream.opensearch.v1;

import "ai/pipestream/opensearch/v1/opensearch_document.proto";
import "google/protobuf/any.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/wrappers.proto";

option java_multiple_files = true;
option java_package = "ai.pipestream.opensearch.v1";

// The OpenSearchManagerService handles schema management, index lifecycle,
// and administrative operations for OpenSearch indices.
service OpenSearchManagerService {
  // Schema Management (from schema_manager.proto)
  rpc EnsureNestedEmbeddingsFieldExists(EnsureNestedEmbeddingsFieldExistsRequest) returns (EnsureNestedEmbeddingsFieldExistsResponse);

  // Index Lifecycle Operations
  rpc CreateIndex(CreateIndexRequest) returns (CreateIndexResponse);
  // Deletes an OpenSearch index.
  rpc DeleteIndex(DeleteIndexRequest) returns (DeleteIndexResponse);
  // Checks if an OpenSearch index exists.
  rpc IndexExists(IndexExistsRequest) returns (IndexExistsResponse);

  // Document Operations (single documents)
  rpc IndexDocument(IndexDocumentRequest) returns (IndexDocumentResponse);
  // Indexes a document with dynamic schema.
  rpc IndexAnyDocument(IndexAnyDocumentRequest) returns (IndexAnyDocumentResponse);
  // Deletes a document from an index.
  rpc DeleteDocument(DeleteDocumentRequest) returns (DeleteDocumentResponse);
  // Retrieves a document by ID from an index.
  rpc GetDocument(GetDocumentRequest) returns (GetDocumentResponse);

  // Admin Operations
  rpc GetIndexStats(GetIndexStatsRequest) returns (GetIndexStatsResponse);
  // Lists all OpenSearch indices.
  rpc ListIndices(ListIndicesRequest) returns (ListIndicesResponse);

  // Domain-Specific Search Operations
  rpc SearchFilesystemMeta(SearchFilesystemMetaRequest) returns (SearchFilesystemMetaResponse);
}

// === Schema Management Messages (from schema_manager.proto) ===

// Request to ensure a nested embeddings field exists in an OpenSearch index.
// Creates or updates the index mapping to support vector search on nested documents.
message EnsureNestedEmbeddingsFieldExistsRequest {
  // Name of the OpenSearch index to modify
  string index_name = 1;
  // Name of the nested field that will contain embeddings (e.g., "embeddings")
  string nested_field_name = 2;
  // Vector field configuration including dimensions and k-NN parameters
  VectorFieldDefinition vector_field_definition = 3;
}

// Defines the structure and parameters for a vector embedding field.
message VectorFieldDefinition {
  // Number of dimensions in the vector (e.g., 768 for many BERT models, 1536 for OpenAI)
  int32 dimension = 1;
  // k-NN search method configuration for this vector field
  KnnMethodDefinition knn_method = 2;
}

// Configuration for k-NN (k-nearest neighbors) vector search method.
message KnnMethodDefinition {
  // Supported k-NN engines for vector similarity search
  enum KnnEngine {
    // Unspecified engine (default to OpenSearch's default)
    KNN_ENGINE_UNSPECIFIED = 0;
  }

  // Distance metrics for vector similarity calculation
  enum SpaceType {
    // Unspecified space type
    SPACE_TYPE_UNSPECIFIED = 0;
    // Cosine similarity: measures angle between vectors (normalized dot product)
    SPACE_TYPE_COSINESIMIL = 1;
    // Inner product: raw dot product similarity
    SPACE_TYPE_INNERPRODUCT = 2;
  }

  // k-NN engine to use for indexing and search
  KnnEngine engine = 1;
  // Distance metric to use for vector similarity
  SpaceType space_type = 2;
  // Algorithm-specific tuning parameters
  KnnParametersDefinition parameters = 3;
}

// Fine-tuning parameters for HNSW (Hierarchical Navigable Small World) algorithm.
// These control the tradeoff between search accuracy, speed, and index size.
message KnnParametersDefinition {
  // Number of bi-directional links per node (higher = more accurate but larger index)
  google.protobuf.Int32Value m = 1;
  // Size of dynamic candidate list during index construction (higher = better quality)
  google.protobuf.Int32Value ef_construction = 2;
  // Size of dynamic candidate list during search (higher = more accurate but slower)
  google.protobuf.Int32Value ef_search = 3;
}

// Response indicating whether the nested embeddings schema was created or already existed.
message EnsureNestedEmbeddingsFieldExistsResponse {
  // True if the schema already existed, false if it was newly created
  bool schema_existed = 1;
}

// === Index Lifecycle Messages ===

// Request to create a new OpenSearch index with vector search capabilities.
message CreateIndexRequest {
  // Name of the index to create (must be lowercase, no spaces)
  string index_name = 1;
  // Vector field configuration for embedding search
  VectorFieldDefinition vector_field_definition = 2;
  // Optional document type hint for schema generation
  optional string document_type = 3;
  // Optional custom OpenSearch index settings (shards, replicas, etc.)
  optional google.protobuf.Struct settings = 4;
}

// Response from index creation operation.
message CreateIndexResponse {
  // Whether the index was created successfully
  bool success = 1;
  // Status message or error details
  string message = 2;
}

// Request to delete an OpenSearch index and all its documents.
message DeleteIndexRequest {
  // Name of the index to delete
  string index_name = 1;
}

// Response from index deletion operation.
message DeleteIndexResponse {
  // Whether the index was deleted successfully
  bool success = 1;
  // Status message or error details
  string message = 2;
}

// Request to check if an OpenSearch index exists.
message IndexExistsRequest {
  // Name of the index to check
  string index_name = 1;
}

// Response indicating whether the requested index exists.
message IndexExistsResponse {
  // True if the index exists, false otherwise
  bool exists = 1;
}

// === Document Operation Messages ===

// Request to index a strongly-typed OpenSearchDocument into an index.
message IndexDocumentRequest {
  // Name of the index to insert the document into
  string index_name = 1;
  // The document to index (using canonical OpenSearchDocument schema)
  OpenSearchDocument document = 2;
  // Optional document ID (if not provided, OpenSearch auto-generates one)
  optional string document_id = 3;
  // Optional routing value for controlling shard placement
  optional string routing = 4;
}

// Request to index any protobuf message type with dynamic schema mapping.
// Enables indexing custom protobuf types without predefined mapping.
message IndexAnyDocumentRequest {
  // Name of the index to insert the document into
  string index_name = 1;
  // The document to index (can be any protobuf message type)
  google.protobuf.Any document = 2;
  // Optional document ID (if not provided, OpenSearch auto-generates one)
  optional string document_id = 3;
  // Optional routing value for controlling shard placement
  optional string routing = 4;
  // ProtoFieldMapper rules for transforming protobuf fields to index fields
  repeated string field_mappings = 5;
}

// Response from indexing a strongly-typed OpenSearchDocument.
message IndexDocumentResponse {
  // Whether the document was indexed successfully
  bool success = 1;
  // The document ID that was indexed (auto-generated if not provided)
  string document_id = 2;
  // Status message or error details
  string message = 3;
}

// Response from indexing a dynamically-typed document.
message IndexAnyDocumentResponse {
  // Whether the document was indexed successfully
  bool success = 1;
  // The document ID that was indexed (auto-generated if not provided)
  string document_id = 2;
  // Status message or error details
  string message = 3;
}

// Request to delete a document from an index by ID.
message DeleteDocumentRequest {
  // Name of the index containing the document
  string index_name = 1;
  // ID of the document to delete
  string document_id = 2;
  // Optional routing value used when the document was indexed
  optional string routing = 3;
}

// Response from document deletion operation.
message DeleteDocumentResponse {
  // Whether the document was deleted successfully
  bool success = 1;
  // Status message or error details
  string message = 2;
}

// Request to retrieve a document from an index by ID.
message GetDocumentRequest {
  // Name of the index containing the document
  string index_name = 1;
  // ID of the document to retrieve
  string document_id = 2;
  // Optional routing value used when the document was indexed
  optional string routing = 3;
}

// Response containing the retrieved document if found.
message GetDocumentResponse {
  // Whether the document was found
  bool found = 1;
  // The retrieved document (only present if found=true)
  optional OpenSearchDocument document = 2;
  // Status message or error details
  string message = 3;
}

// === Admin Operation Messages ===

// Request to retrieve statistics about an OpenSearch index.
message GetIndexStatsRequest {
  // Name of the index to get statistics for
  string index_name = 1;
}

// Response containing index statistics and health metrics.
message GetIndexStatsResponse {
  // Whether the stats retrieval was successful
  bool success = 1;
  // Total number of documents in the index
  int64 document_count = 2;
  // Total size of the index in bytes (including all replicas)
  int64 size_in_bytes = 3;
  // Additional OpenSearch-specific statistics (shards, segments, etc.)
  google.protobuf.Struct additional_stats = 4;
  // Status message or error details
  string message = 5;
}

// Request to list all OpenSearch indices, optionally filtered by prefix.
message ListIndicesRequest {
  // Optional prefix to filter index names (e.g., "prod-" to list only production indices)
  optional string prefix_filter = 1;
}

// Response containing a list of indices and their basic information.
message ListIndicesResponse {
  // List of index information objects
  repeated IndexInfo indices = 1;
}

// Basic information about a single OpenSearch index.
message IndexInfo {
  // Name of the index
  string name = 1;
  // Total number of documents in the index
  int64 document_count = 2;
  // Total size of the index in bytes
  int64 size_in_bytes = 3;
  // Index health status (green, yellow, red)
  string status = 4;
}

// === Domain-Specific Search Messages ===

// Request to search filesystem metadata (files/folders) in a drive.
// Supports text search, filtering by node type, metadata filters, and pagination.
message SearchFilesystemMetaRequest {
  // Drive identifier to search within
  string drive = 1;
  // Text query to search in file/folder names and descriptions
  string query = 2;
  // Filter by node types (e.g., ["FILE"], ["FOLDER"], or both)
  repeated string node_types = 3;
  // Exact metadata key-value pairs to filter by
  map<string, string> metadata_filters = 4;
  // Optional parent folder ID to limit search scope to specific directory
  optional string parent_id = 5;
  // Number of results per page (default 50)
  int32 page_size = 6;
  // Pagination token from previous response for next page
  string page_token = 7;
  // Future feature: whether to search within file contents (not just metadata)
  optional bool include_content_search = 8;
}

// Response containing filesystem search results with pagination support.
message SearchFilesystemMetaResponse {
  // List of matching files/folders
  repeated FilesystemSearchResult results = 1;
  // Total count of matching documents (across all pages)
  int64 total_count = 2;
  // Token to fetch the next page of results (empty if no more results)
  string next_page_token = 3;
  // Highest relevance score in this result set
  float max_score = 4;
}

// A single filesystem search result representing a file or folder.
message FilesystemSearchResult {
  // Unique node identifier
  string node_id = 1;
  // Name of the file or folder
  string name = 2;
  // Type of node (FILE or FOLDER)
  string node_type = 3;
  // Drive identifier this node belongs to
  string drive = 4;
  // Parent folder ID (empty for root-level nodes)
  optional string parent_id = 5;
  // Additional metadata key-value pairs associated with this node
  map<string, string> metadata = 6;
  // Search relevance score (higher = more relevant)
  float score = 7;
  // OpenSearch highlight snippets showing where query terms matched
  google.protobuf.Struct highlights = 8;
}
