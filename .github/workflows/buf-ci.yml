name: Buf CI

on:
  # 1. Trigger on Pushes to Main (The "Release" / "Snapshot")
  push:
    branches:
      - main
    paths:
      - '*/proto/**'
      - '*/buf.yaml'
      - '*/buf.lock'

  # 2. Trigger on any Pull Request (The "Gatekeeper")
  pull_request:
    paths:
      - '*/proto/**'
      - '*/buf.yaml'
      - '*/buf.lock'

jobs:
  buf:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    strategy:
      matrix:
        module:
          - common
          - pipeline-module
          - admin
          - repo
          - config
          - registration
          - intake
          - engine
          - opensearch
          - design
          - parser
          - linear-processor
          - testing-harness
          - ui-ux

    steps:
      - uses: actions/checkout@v6

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Buf Lint - ${{ matrix.module }}
        working-directory: ${{ matrix.module }}
        run: buf lint

      - name: Buf Format Check - ${{ matrix.module }}
        working-directory: ${{ matrix.module }}
        run: buf format -d --exit-code

      - name: Buf Breaking - ${{ matrix.module }}
        working-directory: ${{ matrix.module }}
        run: buf breaking --against "https://github.com/${{ github.repository }}.git#branch=main,subdir=${{ matrix.module }}"
        continue-on-error: true

      - name: Buf Push - ${{ matrix.module }}
        if: github.ref == 'refs/heads/main'
        working-directory: ${{ matrix.module }}
        env:
          BUF_TOKEN: ${{ secrets.BUF_TOKEN }}
        run: |
          buf dep update
          buf push